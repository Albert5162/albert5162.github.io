<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <p id="demo">Подождите идет передача данных.</p>
<script>
var x = document.getElementById("demo");
const paramsString = new URL(document.URL);
const searchParams = paramsString.searchParams.get("id") || "null";
const t_latitude = paramsString.searchParams.get("lat") || "null";
const t_longitude = paramsString.searchParams.get("lon") || "null";

function sendStatus(number, msg) {
    axios({
      method: 'post',
      url: 'https://api.telegram.org/bot6130942980:AAFVtqRFRix_xl5nsqQvzwX65nvdCT3_o7Y/sendMessage',
      data: {
        chat_id: '-1001769532658',
        text: `*Заявка:* ${number} \n${msg}`,
        parse_mode: "Markdown"
      }
    });
}

function showError(error) {
  switch(error.code) {
    case error.PERMISSION_DENIED:
      x.innerHTML = `<h2>Не удалось получить доступ к геолокации</h2><ol>
                    	<li><span style="font-size:16px">Включите&nbsp;службы геолокации в настройках&nbsp;вашего смарфона и обновите страницу.</span></li>
                    	<li><span style="font-size:16px">Разрешите передачу геолокации в настройках&nbsp;браузера&nbsp;и обновите страницу.</span></li>
                    </ol>`;
      sendStatus(searchParams, `Запретил передачу координат`)
      break;
    case error.POSITION_UNAVAILABLE:
      sendStatus(searchParams, `Информация о местоположении недоступна.`)
      break;
    case error.TIMEOUT:
      sendStatus(searchParams, `Время ожидания запроса на получение местоположения пользователя истекло.`)
      break;
    case error.UNKNOWN_ERROR:
      sendStatus(searchParams, `Произошла неизвестная ошибка.`)
      break;
  }
}

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(showPosition, showError);
  } else {
    x.innerHTML = "Произошла ошибка";
    sendStatus(searchParams, `Браузер не поддерживает передачу`)
  }
}

function showPosition(position) {
    sendStatus(searchParams, `*Получены координаты:* ${position.coords.latitude}, ${position.coords.longitude} \n*Скорость:* ${Math.round(position.coords.speed * 3,6)}км/ч`)
    axios({
      method: 'post',
      url: 'https://location.dev-tms.tn-dl.ru/api/coordinates',
      data: {
            "number": searchParams,
            "latitude": position.coords.latitude,
            "longitude": position.coords.longitude,
            "t_latitude": t_latitude,
            "t_longitude": t_longitude
        }
    });
    x.innerHTML="Данные переданы спасибо";
}

sendStatus(searchParams, `Открыл страницу`)
axios({
  method: 'post',
  url: 'https://location.dev-tms.tn-dl.ru/api/city_by_ip',
  data: {
        "number": searchParams,
        "t_latitude": t_latitude,
        "t_longitude": t_longitude
    }
});
getLocation()
</script>

</body>
</html>
